<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Scheduler</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- 头部 -->
            <header class="header">
                <div class="header-content">
                    <div class="header-left">
                        <h2>Task Scheduler</h2>
                    </div>
                    <div class="header-right">
                        <button class="btn btn-primary" @click="showCreateDialog">
                            Create Task
                        </button>
                    </div>
                </div>
            </header>

            <!-- 主内容区 -->
            <main class="main">
                <div class="row">
                    <!-- 任务列表 -->
                    <div class="col-16">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Tasks</div>
                                <div class="card-actions">
                                    <input
                                        type="text"
                                        class="search-input"
                                        v-model="searchQuery"
                                        placeholder="Search tasks..."
                                        @input="handleSearch"
                                    >
                                    <div class="btn-group">
                                        <button
                                            class="btn"
                                            :class="{'btn-primary': viewMode === 'table'}"
                                            @click="viewMode = 'table'"
                                        >
                                            Table
                                        </button>
                                        <button
                                            class="btn"
                                            :class="{'btn-primary': viewMode === 'card'}"
                                            @click="viewMode = 'card'"
                                        >
                                            Card
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- 表格视图 -->
                            <div v-if="viewMode === 'table'" class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Schedule Type</th>
                                            <th>Last Run</th>
                                            <th>Next Run</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr v-for="task in filteredTasks" :key="task.id">
                                            <td>{{ task.name }}</td>
                                            <td>
                                                <span class="tag">{{ task.schedule_type }}</span>
                                            </td>
                                            <td>{{ formatDateTime(task.last_run_time) }}</td>
                                            <td>{{ formatDateTime(task.next_run_time) }}</td>
                                            <td>
                                                <span
                                                    class="tag"
                                                    :class="task.is_active ? 'tag-success' : 'tag-info'"
                                                >
                                                    {{ task.is_active ? 'Active' : 'Inactive' }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group">
                                                    <button class="btn btn-small" @click="executeTask(task)">
                                                        Run
                                                    </button>
                                                    <button class="btn btn-small btn-primary" @click="showEditDialog(task)">
                                                        Edit
                                                    </button>
                                                    <button class="btn btn-small btn-danger" @click="deleteTask(task)">
                                                        Delete
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- 卡片视图 -->
                            <div v-else class="card-grid">
                                <div
                                    v-for="task in filteredTasks"
                                    :key="task.id"
                                    class="task-card"
                                    :class="{'selected': selectedTask?.id === task.id}"
                                    @click="selectTask(task)"
                                >
                                    <div class="task-card-header">
                                        <span
                                            class="tag"
                                            :class="task.is_active ? 'tag-success' : 'tag-info'"
                                        >
                                            {{ task.is_active ? 'Active' : 'Inactive' }}
                                        </span>
                                        <h3>{{ task.name }}</h3>
                                    </div>
                                    <div class="task-card-content">
                                        <p>{{ task.description || 'No description' }}</p>
                                        <div class="task-card-info">
                                            <span>Next Run: {{ formatDateTime(task.next_run_time) }}</span>
                                            <span>Type: {{ task.schedule_type }}</span>
                                        </div>
                                    </div>
                                    <div class="task-card-actions">
                                        <button class="btn btn-small" @click.stop="executeTask(task)">
                                            Run
                                        </button>
                                        <button class="btn btn-small btn-primary" @click.stop="showEditDialog(task)">
                                            Edit
                                        </button>
                                        <button class="btn btn-small btn-danger" @click.stop="deleteTask(task)">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 任务历史 -->
                    <div class="col-8">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Task History</div>
                                <div v-if="selectedTask" class="card-actions">
                                    <button class="btn btn-small btn-primary" @click="refreshHistory">
                                        Refresh
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div v-if="selectedTask" class="history-list">
                                    <div
                                        v-for="history in taskHistory"
                                        :key="history.id"
                                        class="history-item"
                                    >
                                        <div class="history-header">
                                            <span
                                                class="tag"
                                                :class="'tag-' + formatStatus(history.status)"
                                            >
                                                {{ history.status }}
                                            </span>
                                            <span class="history-time">
                                                {{ formatDateTime(history.start_time) }}
                                            </span>
                                        </div>
                                        <div class="history-content">
                                            <div v-if="history.error" class="history-error">
                                                <pre>{{ history.error }}</pre>
                                            </div>
                                            <div v-if="history.output" class="history-output">
                                                <pre>{{ history.output }}</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div v-else class="empty-state">
                                    <p>Select a task to view its history</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- 任务表单对话框 -->
        <div v-if="dialogVisible" class="dialog-overlay" @click="dialogVisible = false">
            <div class="dialog" @click.stop>
                <div class="dialog-header">
                    <h3>{{ isEdit ? 'Edit Task' : 'Create Task' }}</h3>
                    <button class="close-btn" @click="dialogVisible = false">&times;</button>
                </div>
                <div class="dialog-body">
                    <form @submit.prevent="saveTask" class="form">
                        <div class="form-group">
                            <label>Name</label>
                            <input
                                type="text"
                                v-model="taskForm.name"
                                class="form-control"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label>Description</label>
                            <textarea
                                v-model="taskForm.description"
                                class="form-control"
                                rows="3"
                            ></textarea>
                        </div>

                        <div class="form-group">
                            <label>Script Path</label>
                            <input
                                type="text"
                                v-model="taskForm.script_path"
                                class="form-control"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label>Schedule Type</label>
                            <select
                                v-model="taskForm.schedule_type"
                                class="form-control"
                                required
                            >
                                <option
                                    v-for="type in scheduleTypes"
                                    :key="type.value"
                                    :value="type.value"
                                >
                                    {{ type.label }}
                                </option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Schedule Config</label>
                            <input
                                type="text"
                                v-model="taskForm.schedule_config"
                                class="form-control"
                                :placeholder="getSchedulePlaceholder(taskForm.schedule_type)"
                                required
                            >
                            <small class="form-help">
                                {{ getScheduleHelp(taskForm.schedule_type) }}
                            </small>
                        </div>

                        <div class="form-group">
                            <label>Status</label>
                            <div class="switch">
                                <input
                                    type="checkbox"
                                    v-model="taskForm.is_active"
                                    id="status-switch"
                                >
                                <label for="status-switch">
                                    {{ taskForm.is_active ? 'Active' : 'Inactive' }}
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="dialog-footer">
                    <button class="btn" @click="dialogVisible = false">Cancel</button>
                    <button
                        class="btn btn-primary"
                        @click="saveTask"
                        :disabled="loading"
                    >
                        {{ isEdit ? 'Update' : 'Create' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="/static/js/app.js"></script>
</body>
</html>